{% extends "base.html" %}

{% block title %}‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô - ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå{% endblock %}

{% block head_extra %}
<style>
  :root {
    --pending: #f59e0b;
    --confirmed: #3b82f6;
    --preparing: #8b5cf6;
    --completed: #10b981;
  }

  .page-container { max-width: 1200px; margin: 0 auto; padding: 1rem; }

  .page-header {
    margin-bottom: 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .stats-overview {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
  }

  .stat-card {
    background: white;
    padding: 1rem 1.5rem;
    border-radius: 10px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    min-width: 140px;
    flex: 1;
    text-align: center;
    border-top: 4px solid #9ca3af;
  }

  .stat-pending   { border-top-color: var(--pending); }
  .stat-confirmed { border-top-color: var(--confirmed); }
  .stat-preparing { border-top-color: var(--preparing); }
  .stat-completed { border-top-color: var(--completed); }

  .stat-value { font-size: 2rem; font-weight: 700; }

  /* Tabs */
  .tab-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    border-bottom: 2px solid #e5e7eb;
  }

  .tab-btn {
    padding: 0.7rem 1.4rem;
    background: #f3f4f6;
    border: none;
    border-radius: 8px 8px 0 0;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s;
  }

  .tab-btn.active {
    background: white;
    border-bottom: 4px solid;
  }

  .tab-btn[data-tab="pending"].active   { border-bottom-color: var(--pending); color: var(--pending); }
  .tab-btn[data-tab="confirmed"].active { border-bottom-color: var(--confirmed); color: var(--confirmed); }
  .tab-btn[data-tab="preparing"].active { border-bottom-color: var(--preparing); color: var(--preparing); }
  .tab-btn[data-tab="completed"].active { border-bottom-color: var(--completed); color: var(--completed); }

  .tab-content { display: none; }
  .tab-content.active { display: block; }

  /* Order card */
  .order-item {
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    margin-bottom: 1.25rem;
    overflow: hidden;
  }

  .order-summary {
    padding: 1.25rem 1.5rem;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
    background: #f8fafc;
  }

  .order-summary:hover { background: #f1f5f9; }

  .order-details {
    padding: 0 1.5rem 1.5rem;
    border-top: 1px solid #e5e7eb;
  }

  .status-badge {
    padding: 0.4rem 1rem;
    border-radius: 999px;
    font-size: 0.9rem;
    font-weight: 600;
    white-space: nowrap;
  }

  .badge-pending    { background: #fef3c7; color: #92400e; }
  .badge-confirmed  { background: #dbeafe; color: #1e40af; }
  .badge-preparing  { background: #f3e8ff; color: #6b21a8; }
  .badge-completed  { background: #d1fae5; color: #065f46; }

  /* Action buttons */
  .action-btn {
    padding: 0.6rem 1.2rem;
    border: none;
    border-radius: 6px;
    font-weight: 500;
    cursor: pointer;
    transition: 0.2s;
    color: white;
  }

  .btn-confirm   { background: var(--confirmed); }
  .btn-prepare   { background: var(--preparing); }
  .btn-complete  { background: var(--completed); }

  .action-btn:hover { opacity: 0.9; }
  .action-btn:disabled { opacity: 0.5; cursor: not-allowed; }

  .empty-state {
    text-align: center;
    padding: 5rem 1rem;
    color: #6b7280;
    background: #f9fafb;
    border-radius: 12px;
  }

  .empty-icon { font-size: 5rem; margin-bottom: 1rem; }
  /* Search box */
.search-box {
  display: flex;
  gap: 0.5rem;
  align-items: center;
}

.search-input {
  padding: 0.6rem 0.9rem;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  outline: none;
  font-size: 0.95rem;
  width: 180px;
  transition: 0.2s;
}

.search-input:focus {
  border-color: var(--confirmed);
  box-shadow: 0 0 0 3px rgba(59,130,246,0.15);
}

.search-btn {
  padding: 0.6rem 1.2rem;
  background: linear-gradient(135deg, #3b82f6, #2563eb);
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  transition: 0.2s;
  display: flex;
  align-items: center;
  gap: 0.4rem;
}

.search-btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 10px rgba(59,130,246,0.25);
}

.search-btn:active {
  transform: translateY(0);
}

</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/11.12.4/sweetalert2.all.min.js"></script>
{% endblock %}

{% block content %}

<div class="page-container">

<div class="page-header">
  <h1>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</h1>

  <form class="search-box" onsubmit="goToOrder(event)">
    <input 
      type="number" 
      id="orderIdInput"
      class="search-input"
      placeholder="üîé Order ID"
      required
    >
    <button type="submit" class="search-btn">
      ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
    </button>
  </form>

</div>


  <div class="stats-overview">
    <div class="stat-card stat-pending">
      <div class="stat-label">‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</div>
      <div class="stat-value">{{ pending_count|default(0) }}</div>
    </div>
    <div class="stat-card stat-confirmed">
      <div class="stat-label">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß</div>
      <div class="stat-value">{{ confirmed_count|default(0) }}</div>
    </div>
    <div class="stat-card stat-preparing">
      <div class="stat-label">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡∏Ç‡∏≠‡∏á</div>
      <div class="stat-value">{{ preparing_count|default(0) }}</div>
    </div>
    <div class="stat-card stat-completed">
      <div class="stat-label">‡∏õ‡∏¥‡∏î‡∏à‡πä‡∏≠‡∏ö</div>
      <div class="stat-value">{{ completed_count|default(0) }}</div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tab-buttons">
    <button class="tab-btn active" data-tab="pending">‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
    <button class="tab-btn" data-tab="confirmed">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß</button>
    <button class="tab-btn" data-tab="preparing">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡∏Ç‡∏≠‡∏á</button>
    <button class="tab-btn" data-tab="completed">‡∏õ‡∏¥‡∏î‡∏à‡πä‡∏≠‡∏ö</button>
  </div>

  <!-- Tab: ‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô -->
<div class="tab-content active" id="tab-pending"
     hx-get="/admin/orders/pending-partial"
     hx-trigger="every 15s"
     hx-swap="innerHTML">
    {% if pending_orders %}
      {% for order_id, order in pending_orders|dictsort(reverse=true) %}
        {% with %}
          {% set next_status = 'confirmed' %}
          {% set action_text = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå' %}
          {% set action_class = 'btn-confirm' %}
          {% include 'admin_order_card.html' %}
        {% endwith %}
      {% endfor %}
    {% else %}
      <div class="empty-state">
        <div class="empty-icon">‚è≥</div>
        <h3>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</h3>
        <p>‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà‡∏à‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</p>
      </div>
    {% endif %}
  </div>

  <!-- Tab: ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß -->
  <div class="tab-content" id="tab-confirmed">
    {% if confirmed_orders %}
      {% for order_id, order in confirmed_orders|dictsort(reverse=true) %}
        {% with %}
          {% set next_status = 'preparing' %}
          {% set action_text = '‡∏à‡∏±‡∏î‡∏Ç‡∏≠‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß' %}
          {% set action_class = 'btn-prepare' %}
          {% include 'admin_order_card.html' %}
        {% endwith %}
      {% endfor %}
    {% else %}
      <div class="empty-state">
        <div class="empty-icon">üìã</div>
        <h3>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß</h3>
      </div>
    {% endif %}
  </div>

  <!-- Tab: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡∏Ç‡∏≠‡∏á -->
  <div class="tab-content" id="tab-preparing">
    {% if preparing_orders %}
      {% for order_id, order in preparing_orders|dictsort(reverse=true) %}
        {% with %}
          {% set next_status = 'completed' %}
          {% set action_text = '‡∏õ‡∏¥‡∏î‡∏à‡πä‡∏≠‡∏ö / ‡∏™‡πà‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢' %}
          {% set action_class = 'btn-complete' %}
          {% include 'admin_order_card.html' %}
        {% endwith %}
      {% endfor %}
    {% else %}
      <div class="empty-state">
        <div class="empty-icon">üì¶</div>
        <h3>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡∏Ç‡∏≠‡∏á</h3>
      </div>
    {% endif %}
  </div>

  <!-- Tab: ‡∏õ‡∏¥‡∏î‡∏à‡πä‡∏≠‡∏ö -->
  <div class="tab-content" id="tab-completed">
    {% if completed_orders %}
      {% for order_id, order in completed_orders|dictsort(reverse=true) %}
        <div class="order-item">
          <div class="order-summary">
            <div>
              <strong>Order #{{ order.id }}</strong><br>
              <span style="color:#4b5563;">{{ order.customer_name|e }}</span>
            </div>
            <div class="text-right" style="min-width:220px;">
              <div>üìû {{ order.phone|e }}</div>
              <div>üïí {{ order.created_at|dateformat }}</div>
              <div style="margin-top:0.5rem; font-size:1.2rem;">
                <strong>{{ order.total|int|default(0) }} ‡∏ö‡∏≤‡∏ó</strong>
              </div>
            </div>
            <div style="width:100%; margin-top:0.75rem; text-align:center;">
              <span class="status-badge badge-completed">‚úì ‡∏õ‡∏¥‡∏î‡∏à‡πä‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß</span>
            </div>
          </div>
          <div class="order-details">
            <table class="order-table">
              <thead>
                <tr>
                  <th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                  <th class="text-right">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                  <th class="text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                  <th class="text-right">‡∏£‡∏ß‡∏°</th>
                </tr>
              </thead>
              <tbody>
                {% for item in order.get('items', []) %}
                  <tr>
                    <td>{{ item.product|e }}</td>
                    <td class="text-right">{{ item.price|int }} ‡∏ö‡∏≤‡∏ó</td>
                    <td class="text-center">{{ item.qty }}</td>
                    <td class="text-right">{{ item.subtotal|int }} ‡∏ö‡∏≤‡∏ó</td>
                  </tr>
                {% else %}
                  <tr><td colspan="4" class="text-center">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</td></tr>
                {% endfor %}
                <tr class="total-row">
                  <td colspan="3" class="text-right">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</td>
                  <td class="text-right">{{ order.total|int|default(0) }} ‡∏ö‡∏≤‡∏ó</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <div class="empty-state">
        <div class="empty-icon">üèÅ</div>
        <h3>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏õ‡∏¥‡∏î‡∏à‡πä‡∏≠‡∏ö</h3>
      </div>
    {% endif %}
  </div>

</div>

<script>
// Tab switching
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

    btn.classList.add('active');
    document.getElementById(`tab-${btn.dataset.tab}`).classList.add('active');
  });
});

// Status change handler
document.addEventListener('click', function(e) {
  if (!e.target.classList.contains('action-btn')) return;
  
  e.preventDefault();
  
  const btn = e.target;
  if (btn.disabled) return;

  const form = btn.closest('form');
  const orderId = btn.dataset.orderId;
  const customerName = btn.dataset.customerName;
  const nextStatus = btn.dataset.nextStatus;

  let titleText = '';
  switch(nextStatus) {
    case 'confirmed':  titleText = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå'; break;
    case 'preparing':  titleText = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏à‡∏±‡∏î‡∏Ç‡∏≠‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß'; break;
    case 'completed':  titleText = '‡∏õ‡∏¥‡∏î‡∏à‡πä‡∏≠‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ'; break;
    default: titleText = '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞';
  }

  Swal.fire({
    title: titleText + ' ?',
    html: `Order <strong>#${orderId}</strong><br>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: <strong>${customerName}</strong>`,
    icon: 'question',
    showCancelButton: true,
    confirmButtonColor: btn.style.backgroundColor || '#10b981',
    cancelButtonColor: '#ef4444',
    confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£',
    cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
  }).then((result) => {
    if (result.isConfirmed) {
      form.submit();
    }
  });
});

// Auto-refresh pending tab + count
function refreshPending() {
  fetch('/admin/orders/pending-update')
    .then(response => {
      if (!response.ok) throw new Error('Network error');
      return response.json();
    })
    .then(data => {
      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
      document.querySelector('.stat-pending .stat-value').textContent = data.pending_count || 0;

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô tab ‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
      const pendingTab = document.getElementById('tab-pending');
      if (pendingTab) {
        pendingTab.innerHTML = data.pending_html;
      }

      console.log('Pending orders updated:', data.pending_count);
    })
    .catch(error => {
      console.error('Pending refresh error:', error);
    });
}

// ‡πÄ‡∏£‡∏¥‡πà‡∏° polling ‡∏ó‡∏∏‡∏Å 15 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
setInterval(refreshPending, 15000);

// ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
window.addEventListener('load', refreshPending);

function goToOrder(e){
  e.preventDefault();
  const orderId = document.getElementById("orderIdInput").value.trim();

  if(!orderId) return;

  window.location.href = "/admin/order/" + orderId;
}

</script>

{% endblock %}