{% extends "base.html" %}

{% block title %}สั่งซื้อสินค้า - ของไหว้{% endblock %}

{% block head_extra %}
<style>
  /* Tab สไตล์เรียบง่าย */
  .tab-container {
    margin-bottom: 1.5rem;
  }
  .tab-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1rem;
    border-bottom: 2px solid #e5e7eb;
  }
  .tab-button {
    padding: 0.6rem 1.2rem;
    background: #f3f4f6;
    border: none;
    border-radius: 8px 8px 0 0;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s;
  }
  .tab-button.active {
    background: var(--primary);
    color: white;
  }
  .tab-button:hover:not(.active) {
    background: #e5e7eb;
  }
  .tab-content {
    display: none;
  }
  .tab-content.active {
    display: block;
  }
  .empty-category {
    text-align: center;
    color: #6b7280;
    padding: 2rem;
    font-style: italic;
  }
</style>
{% endblock %}

{% block content %}

<h2>สั่งซื้อสินค้า - หมวดของไหว้</h2>

{% if success %}
<div class="success-message" style="background:#ecfdf5; color:#065f46; padding:1.5rem; border-radius:8px; margin-bottom:2rem; text-align:center; border:1px solid #a7f3d0;">
  <span style="font-size:1.5rem;">✅</span>
  <p style="margin:0.5rem 0 0;">บันทึกสำเร็จ</p>
  <p style="margin:0.5rem 0 0; font-size:1.1rem;">ขอบคุณที่สั่งซื้อค่ะ เราจะติดต่อกลับโดยเร็วที่สุด</p>
</div>
{% endif %}

<form method="post" action="/order" class="order-form" id="orderForm">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

  <div class="form-group" style="margin-bottom:1.5rem;">
    <label for="name">ชื่อผู้สั่งซื้อ <span class="required" style="color:red;">*</span></label>
    <input type="text" id="name" name="name" required 
           placeholder="เช่น นายสมชาย ใจดี" 
           value="{% if session.username %}{{ session.username }}{% endif %}" 
           autocomplete="name"
           style="width:100%; padding:0.8rem; border:1px solid #d1d5db; border-radius:6px; font-size:1rem;">
  </div>

  <div class="form-group" style="margin-bottom:1.5rem;">
    <label for="phone">เบอร์โทรศัพท์ <span class="required" style="color:red;">*</span></label>
    <input type="tel" id="phone" name="phone" required 
           placeholder="เช่น 0812345678" 
           pattern="[0-9]{9,10}" inputmode="numeric" autocomplete="tel"
           value="{% if session.phone %}{{ session.phone }}{% endif %}"
           style="width:100%; padding:0.8rem; border:1px solid #d1d5db; border-radius:6px; font-size:1rem;">
    
    {% if session.username %}
      <small class="form-hint" style="display:block; margin-top:0.5rem; color:#4b5563; font-size:0.9rem;">
        ※ ล็อกอินแล้ว ระบบนำเบอร์ที่คุณเคยกรอกไว้มาใส่ให้อัตโนมัติ (สามารถแก้ไขได้)
      </small>
    {% else %}
      <small class="form-hint" style="display:block; margin-top:0.5rem; color:#4b5563; font-size:0.9rem;">
        ※ กรุณากรอกเบอร์โทรเพื่อให้ร้านติดต่อกลับได้สะดวก
      </small>
    {% endif %}
  </div>

  <div class="products-section" style="margin:2rem 0;">
    <h3>เลือกสินค้า</h3>

    <!-- Tab หมวดหมู่ (แสดงเฉพาะ "ของไหว้" เป็นหลัก) -->
    <div class="tab-container">
      <div class="tab-buttons">
        <!-- แท็บอื่น ๆ (ถ้าต้องการให้เห็น แต่เริ่มต้นที่ของไหว้) -->
        <button type="button" class="tab-button" data-tab="พวงมาลัย">พวงมาลัย</button>
        <button type="button" class="tab-button active" data-tab="ของไหว้">ของไหว้</button>
        <button type="button" class="tab-button" data-tab="น้ำ">น้ำ</button>
        <button type="button" class="tab-button" data-tab="อื่นๆ">อื่นๆ</button>
        <button type="button" class="tab-button" data-tab="all">ทั้งหมด</button>
      </div>

      <!-- เนื้อหาแต่ละแท็บ -->
      {% for cat in ['พวงมาลัย', 'ของไหว้', 'น้ำ', 'อื่นๆ', 'all'] %}
        <div class="tab-content {% if cat == 'ของไหว้' %}active{% endif %}" id="tab-{{ cat }}">
          
          {% set items = products if cat == 'all' else products|selectattr('category', 'equalto', cat)|list %}
          
          {% if items %}
            <div class="table-responsive" style="overflow-x:auto;">
              <table class="product-table" id="productTable-{{ cat }}" style="width:100%; border-collapse:collapse;">
                <thead>
                  <tr style="background:#f3f4f6;">
                    <th class="check-col" style="padding:1rem; width:60px;">เลือก</th>
                    <th style="padding:1rem;">สินค้า</th>
                    <th class="price-col" style="padding:1rem; width:120px;">ราคา</th>
                    <th class="qty-col" style="padding:1rem; width:120px;">จำนวน</th>
                    <th class="price-col" style="padding:1rem; width:120px;">รวม</th>
                  </tr>
                </thead>
                <tbody>
                  {% for p in items %}
                  <tr class="product-row" data-id="{{ p['id'] }}" data-price="{{ p['price'] }}">
                    <td class="check-col" style="padding:1rem; text-align:center;">
                      <input type="checkbox" name="product_id" value="{{ p['id'] }}" 
                             id="prod_{{ p['id'] }}_{{ cat }}" class="product-check">
                    </td>
                    <td style="padding:1rem;">
                      <label for="prod_{{ p['id'] }}_{{ cat }}">{{ p['name'] }}</label>
                    </td>
                    <td class="price-col" style="padding:1rem; text-align:right;">{{ p['price'] }} บาท</td>
                    <td class="qty-col" style="padding:1rem;">
                      <input type="number" name="qty_{{ p['id'] }}" value="0" min="0" max="999" step="1" 
                             class="qty-input" data-id="{{ p['id'] }}"
                             style="width:80px; padding:0.5rem; text-align:center; border:1px solid #d1d5db; border-radius:4px;">
                    </td>
                    <td class="price-col subtotal" data-id="{{ p['id'] }}" style="padding:1rem; text-align:right;">0 บาท</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="empty-category">
              ยังไม่มีสินค้าในหมวด "{{ cat }}" ในขณะนี้
            </div>
          {% endif %}
        </div>
      {% endfor %}
    </div>

    <div class="total-preview" style="margin:1.5rem 0; text-align:right; font-size:1.3rem;">
      ยอดรวมทั้งสิ้น: <strong id="grandTotal">0 บาท</strong>
    </div>

    <p class="hint" style="color:#6b7280; font-size:0.95rem; margin:1rem 0;">
      ※ เลือกสินค้าและระบุจำนวน หากไม่ต้องการให้ใส่ 0 หรือไม่ติ๊กเลือก
    </p>
    <p class="no-selection" id="noSelectionWarning" style="color:#ef4444; font-weight:600; display:none; text-align:center;">
      กรุณาเลือกอย่างน้อย 1 รายการ และจำนวนต้องมากกว่า 0
    </p>
  </div>

  <div class="submit-area" style="text-align:center; margin-top:2rem;">
    <button type="submit" class="submit-btn" id="submitBtn" 
            style="padding:1rem 3rem; font-size:1.2rem; background:var(--primary); color:white; border:none; border-radius:8px; cursor:pointer;">
      สั่งซื้อเลย
    </button>
  </div>

</form>

<script>
// JavaScript เดิม + การจัดการ tab
const form = document.getElementById('orderForm');
const submitBtn = document.getElementById('submitBtn');
const grandTotalEl = document.getElementById('grandTotal');
const warningEl = document.getElementById('noSelectionWarning');

function updateTotals() {
  let total = 0;
  let hasSelection = false;

  document.querySelectorAll('.product-row').forEach(row => {
    const checkbox = row.querySelector('.product-check');
    const qtyInput = row.querySelector('.qty-input');
    const subtotalEl = row.querySelector('.subtotal');
    const price = parseInt(row.dataset.price) || 0;
    const qty = parseInt(qtyInput.value) || 0;

    if (checkbox.checked && qty > 0) {
      hasSelection = true;
      row.classList.add('selected');
    } else {
      row.classList.remove('selected');
    }

    const subtotal = price * qty;
    subtotalEl.textContent = subtotal.toLocaleString('th-TH') + ' บาท';

    if (checkbox.checked) total += subtotal;
  });

  grandTotalEl.textContent = total.toLocaleString('th-TH') + ' บาท';

  warningEl.style.display = hasSelection ? 'none' : 'block';
  submitBtn.disabled = !hasSelection;
  submitBtn.style.opacity = hasSelection ? '1' : '0.6';
}

// จัดการ tab (เริ่มต้นที่ "ของไหว้")
document.querySelectorAll('.tab-button').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

    btn.classList.add('active');
    const tabId = 'tab-' + btn.dataset.tab;
    document.getElementById(tabId).classList.add('active');

    updateTotals();
  });
});

// Event listeners เดิม
document.querySelectorAll('.product-check, .qty-input').forEach(el => {
  el.addEventListener('change', updateTotals);
  el.addEventListener('input', updateTotals);
});

form.addEventListener('submit', e => {
  const checked = document.querySelectorAll('input[name="product_id"]:checked');
  let valid = false;

  checked.forEach(chk => {
    const qty = document.querySelector(`input[name="qty_${chk.value}"]`);
    if (qty && parseInt(qty.value) > 0) valid = true;
  });

  if (!valid) {
    e.preventDefault();
    alert('กรุณาเลือกสินค้าอย่างน้อย 1 รายการ และระบุจำนวนมากกว่า 0');
  }
});

updateTotals();
</script>

{% endblock %}