{% extends "base.html" %}

{% block title %}สั่งซื้อสินค้า - ของไหว้{% endblock %}

{% block head_extra %}
<style>
  /* Tab สไตล์เดิม */
  .tab-container { margin-bottom: 1.5rem; }
  .tab-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1rem;
    border-bottom: 2px solid #e5e7eb;
  }
  .tab-button {
    padding: 0.6rem 1.2rem;
    background: #f3f4f6;
    border: none;
    border-radius: 8px 8px 0 0;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s;
  }
  .tab-button.active { background: var(--primary); color: white; }
  .tab-button:hover:not(.active) { background: #e5e7eb; }
  .tab-content { display: none; }
  .tab-content.active { display: block; }
  .empty-category {
    text-align: center;
    color: #6b7280;
    padding: 2rem;
    font-style: italic;
  }

  /* ปรับช่องจำนวน + ปุ่ม + / – */
  .qty-wrapper {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    margin-top: 0.3rem;
  }

  .qty-btn {
    width: 36px;
    height: 36px;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 50%;
    font-size: 1.2rem;
    font-weight: bold;
    cursor: pointer;
    touch-action: manipulation;
    user-select: none;
  }

  .qty-btn:hover { background: var(--primary-dark); }
  .qty-btn:active { transform: scale(0.95); }

  .qty-input {
    width: 60px !important;
    text-align: center;
    padding: 0.5rem !important;
    font-size: 1rem;
    border: 1px solid #d1d5db;
    border-radius: 6px;
  }

  /* สไตล์สำหรับแถวที่เลือก */
  .product-row.selected {
    background-color: #f0fdf4;
    border-left: 4px solid #22c55e;
  }

  /* สไตล์ส่วนสรุปการเลือก */
  .selected-summary {
    margin: 2rem 0;
    padding: 1.5rem;
    background: #f0f9ff;
    border: 1px solid #bae6fd;
    border-radius: 12px;
  }

  .selected-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.8rem 0;
    border-bottom: 1px dashed #d1d5db;
  }

  .selected-item:last-child { border-bottom: none; }
  .selected-item-name { flex: 1; font-weight: 500; }
  .selected-item-qty { min-width: 80px; text-align: center; color: #2563eb; font-weight: 600; }
  .selected-item-sub { min-width: 120px; text-align: right; font-weight: 600; color: #1e40af; }

  @media (max-width: 576px) {
    .qty-btn { width: 44px; height: 44px; font-size: 1.4rem; }
    .qty-input { width: 70px !important; font-size: 1.1rem; }
    .selected-item { flex-direction: column; align-items: flex-start; gap: 0.3rem; }
    .selected-item-qty, .selected-item-sub { text-align: left; min-width: auto; }
  }
</style>
{% endblock %}

{% block content %}

<h2>สั่งซื้อสินค้า - หมวดของไหว้</h2>

{% if success %}
<div class="success-message" style="background:#ecfdf5; color:#065f46; padding:1.5rem; border-radius:8px; margin-bottom:2rem; text-align:center; border:1px solid #a7f3d0;">
  <span style="font-size:1.5rem;">✅</span>
  <p style="margin:0.5rem 0 0;">บันทึกสำเร็จ</p>
  <p style="margin:0.5rem 0 0; font-size:1.1rem;">ขอบคุณที่สั่งซื้อค่ะ เราจะติดต่อกลับโดยเร็วที่สุด</p>
</div>
{% endif %}

<form method="post" action="/order" class="order-form" id="orderForm">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

  <!-- ชื่อและเบอร์ -->
  <div class="form-group" style="margin-bottom:1.5rem;">
    <label for="name">ชื่อผู้สั่งซื้อ <span class="required" style="color:red;">*</span></label>
    <input type="text" id="name" name="name" required 
           placeholder="เช่น นายสมชาย ใจดี" 
           value="{% if session.username %}{{ session.username }}{% endif %}" 
           autocomplete="name"
           style="width:100%; padding:0.8rem; border:1px solid #d1d5db; border-radius:6px; font-size:1rem;">
  </div>

  <div class="form-group" style="margin-bottom:1.5rem;">
    <label for="phone">เบอร์โทรศัพท์ <span class="required" style="color:red;">*</span></label>
    <input type="tel" id="phone" name="phone" required 
           placeholder="เช่น 0812345678" 
           pattern="[0-9]{9,10}" inputmode="numeric" autocomplete="tel"
           value="{% if session.phone %}{{ session.phone }}{% endif %}"
           style="width:100%; padding:0.8rem; border:1px solid #d1d5db; border-radius:6px; font-size:1rem;">
    
    {% if session.username %}
      <small class="form-hint" style="display:block; margin-top:0.5rem; color:#4b5563; font-size:0.9rem;">
        ※ ล็อกอินแล้ว ระบบนำเบอร์ที่คุณเคยกรอกไว้มาใส่ให้อัตโนมัติ (สามารถแก้ไขได้)
      </small>
    {% else %}
      <small class="form-hint" style="display:block; margin-top:0.5rem; color:#4b5563; font-size:0.9rem;">
        ※ กรุณากรอกเบอร์โทรเพื่อให้ร้านติดต่อกลับได้สะดวก
      </small>
    {% endif %}
  </div>

  <div class="products-section" style="margin:2rem 0;">
    <h3>เลือกสินค้า</h3>

    <!-- Tab หมวดหมู่ -->
    <div class="tab-container">
      <div class="tab-buttons">
        <button type="button" class="tab-button" data-tab="พวงมาลัย">พวงมาลัย</button>
        <button type="button" class="tab-button active" data-tab="ของไหว้">ของไหว้</button>
        <button type="button" class="tab-button" data-tab="น้ำ">น้ำ</button>
        <button type="button" class="tab-button" data-tab="อื่นๆ">อื่นๆ</button>
        <button type="button" class="tab-button" data-tab="all">ทั้งหมด</button>
      </div>

      {% for cat in ['พวงมาลัย', 'ของไหว้', 'น้ำ', 'อื่นๆ', 'all'] %}
        <div class="tab-content {% if cat == 'ของไหว้' %}active{% endif %}" id="tab-{{ cat }}">
          {% set items = products if cat == 'all' else products|selectattr('category', 'equalto', cat)|list %}
          
          {% if items %}
            <div class="table-responsive" style="overflow-x:auto;">
              <table class="product-table" id="productTable-{{ cat }}" style="width:100%; border-collapse:collapse;">
                <thead>
                  <tr style="background:#f3f4f6;">
                    <th class="check-col" style="padding:1rem; width:60px;">เลือก</th>
                    <th style="padding:1rem;">สินค้า</th>
                    <th class="price-col" style="padding:1rem; width:120px;">ราคา</th>
                    <th class="qty-col" style="padding:1rem; width:140px;">จำนวน</th>
                    <th class="price-col" style="padding:1rem; width:120px;">รวม</th>
                  </tr>
                </thead>
                <tbody>
                  {% for p in items %}
                  <tr class="product-row" data-id="{{ p['id'] }}" data-price="{{ p['price'] }}">
                    <td class="check-col" style="padding:1rem; text-align:center;">
                      <input type="checkbox" name="product_id" value="{{ p['id'] }}" 
                             id="prod_{{ p['id'] }}_{{ cat }}" class="product-check">
                    </td>
                    <td style="padding:1rem;">
                      <label for="prod_{{ p['id'] }}_{{ cat }}">{{ p['name'] }}</label>
                    </td>
                    <td class="price-col" style="padding:1rem; text-align:right;">{{ p['price'] }} บาท</td>
                    <td class="qty-col" style="padding:1rem;">
                      <div class="qty-wrapper">
                        <button type="button" class="qty-btn qty-minus" data-id="{{ p['id'] }}">-</button>
                        <input type="number" name="qty_{{ p['id'] }}" value="0" min="0" max="999" step="1" 
                               class="qty-input" data-id="{{ p['id'] }}">
                        <button type="button" class="qty-btn qty-plus" data-id="{{ p['id'] }}">+</button>
                      </div>
                    </td>
                    <td class="price-col subtotal" data-id="{{ p['id'] }}" style="padding:1rem; text-align:right;">0 บาท</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="empty-category">
              ยังไม่มีสินค้าในหมวด "{{ cat }}" ในขณะนี้
            </div>
          {% endif %}
        </div>
      {% endfor %}
    </div>

    <div class="total-preview" style="margin:1.5rem 0; text-align:right; font-size:1.3rem;">
      ยอดรวมทั้งสิ้น: <strong id="grandTotal">0 บาท</strong>
    </div>

    <!-- ส่วนสรุปรายการที่เลือก (ใหม่) -->
    <div class="selected-summary">
      <h3 style="margin-top:0; color: #1e40af;">รายการที่คุณเลือก</h3>
      <div id="selectedItemsList" style="min-height: 60px;"></div>
      <div style="margin-top:1rem; text-align:right; font-size:1.3rem; font-weight:bold;">
        ยอดรวม: <span id="summaryTotal">0 บาท</span>
      </div>
      <p id="noItemsHint" style="color:#6b7280; text-align:center; margin:1rem 0; display:none;">
        ยังไม่มีรายการที่เลือก
      </p>
    </div>

    <p class="hint" style="color:#6b7280; font-size:0.95rem; margin:1rem 0;">
      ※ เลือกสินค้าและปรับจำนวนด้วยปุ่ม +/– หรือพิมพ์เองได้
    </p>
    <p class="no-selection" id="noSelectionWarning" style="color:#ef4444; font-weight:600; display:none; text-align:center;">
      กรุณาเลือกอย่างน้อย 1 รายการ และจำนวนต้องมากกว่า 0
    </p>
  </div>

  <div class="submit-area" style="text-align:center; margin-top:2rem;">
    <button type="submit" class="submit-btn" id="submitBtn" 
            style="padding:1rem 3rem; font-size:1.2rem; background:var(--primary); color:white; border:none; border-radius:8px; cursor:pointer;">
      สั่งซื้อเลย
    </button>
  </div>

</form>

<script>
// JavaScript สำหรับจัดการการเลือก + สรุป
const form = document.getElementById('orderForm');
const submitBtn = document.getElementById('submitBtn');
const grandTotalEl = document.getElementById('grandTotal');
const summaryTotalEl = document.getElementById('summaryTotal');
const selectedItemsList = document.getElementById('selectedItemsList');
const noItemsHint = document.getElementById('noItemsHint');
const warningEl = document.getElementById('noSelectionWarning');

function updateTotals() {
  let total = 0;
  let hasSelection = false;

  // ล้างรายการสรุปเก่าทิ้ง
  selectedItemsList.innerHTML = '';

  document.querySelectorAll('.product-row').forEach(row => {
    const checkbox = row.querySelector('.product-check');
    const qtyInput = row.querySelector('.qty-input');
    const subtotalEl = row.querySelector('.subtotal');
    const price = parseInt(row.dataset.price) || 0;
    const qty = parseInt(qtyInput.value) || 0;
    const name = row.querySelector('label').textContent.trim();

    const subtotal = price * qty;

    // อัปเดต subtotal ในตาราง
    subtotalEl.textContent = subtotal.toLocaleString('th-TH') + ' บาท';

    // จัดการไฮไลต์แถว + เพิ่มในสรุป
    if (checkbox.checked && qty > 0) {
      row.classList.add('selected');
      hasSelection = true;
      total += subtotal;

      // สร้าง element สำหรับสรุป
      const itemDiv = document.createElement('div');
      itemDiv.className = 'selected-item';
      itemDiv.innerHTML = `
        <span class="selected-item-name">${name}</span>
        <span class="selected-item-qty">× ${qty}</span>
        <span class="selected-item-sub">${subtotal.toLocaleString('th-TH')} บาท</span>
      `;
      selectedItemsList.appendChild(itemDiv);
    } else {
      row.classList.remove('selected');
    }
  });

  // อัปเดตยอดรวมทั้งสองจุด
  const formattedTotal = total.toLocaleString('th-TH') + ' บาท';
  grandTotalEl.textContent = formattedTotal;
  summaryTotalEl.textContent = formattedTotal;

  // แสดง/ซ่อนข้อความแจ้ง
  noItemsHint.style.display = hasSelection ? 'none' : 'block';
  warningEl.style.display = hasSelection ? 'none' : 'block';
  submitBtn.disabled = !hasSelection;
  submitBtn.style.opacity = hasSelection ? '1' : '0.6';
}

// จัดการปุ่ม + และ –
document.querySelectorAll('.qty-plus, .qty-minus').forEach(btn => {
  ['click', 'touchend'].forEach(eventType => {
    btn.addEventListener(eventType, (e) => {
      e.preventDefault();
      const id = btn.dataset.id;
      const input = document.querySelector(`input[name="qty_${id}"]`);
      if (!input) return;

      let value = parseInt(input.value) || 0;

      if (btn.classList.contains('qty-plus')) {
        if (value < 999) value += 1;
      } else {
        if (value > 0) value -= 1;
      }

      input.value = value;
      updateTotals();

      if ('vibrate' in navigator) navigator.vibrate(15);
    });
  });
});

// จัดการ tab
document.querySelectorAll('.tab-button').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

    btn.classList.add('active');
    const tabId = 'tab-' + btn.dataset.tab;
    document.getElementById(tabId).classList.add('active');

    updateTotals();
  });
});

// Event listeners อื่น ๆ
document.querySelectorAll('.product-check, .qty-input').forEach(el => {
  el.addEventListener('change', updateTotals);
  el.addEventListener('input', updateTotals);
});

// ตรวจสอบก่อน submit
form.addEventListener('submit', e => {
  const checked = document.querySelectorAll('input[name="product_id"]:checked');
  let valid = false;

  checked.forEach(chk => {
    const qty = document.querySelector(`input[name="qty_${chk.value}"]`);
    if (qty && parseInt(qty.value) > 0) valid = true;
  });

  if (!valid) {
    e.preventDefault();
    alert('กรุณาเลือกสินค้าอย่างน้อย 1 รายการ และระบุจำนวนมากกว่า 0');
  }
});

// อัปเดตครั้งแรก
updateTotals();
</script>

{% endblock %}